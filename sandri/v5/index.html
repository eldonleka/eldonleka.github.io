<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Toy Shop Manager</title>

<!-- ===================== -->
<!-- GLOBAL STYLES -->
<!-- ===================== -->
<style>
body {
  font-family: Arial;
  margin: 20px;
  background: #f4f4f4;
}

.card {
  background: white;
  padding: 15px;
  margin: 10px 0;
  border-radius: 8px;
}

button {
  padding: 8px 12px;
  margin: 4px;
  cursor: pointer;
}

input, select {
  padding: 6px;
  margin: 4px;
}

table {
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #ccc;
  padding: 6px;
}

.nav button {
  background: #333;
  color: white;
}
</style>
</head>

<body>

<h2>Toy Shop Manager</h2>

<!-- ===================== -->
<!-- FIRST TIME SETUP -->
<!-- ===================== -->
<div id="setupBox" class="card" style="display:none">
  <h3>First Time Setup</h3>

  <!-- Create master password -->
  <input type="password" id="newpw" placeholder="Create master password">
  <button onclick="createMaster()">Create Password</button>

  <hr>

  <!-- Restore backup -->
  <input type="file" onchange="restore(event)">
</div>

<!-- ===================== -->
<!-- LOGIN -->
<!-- ===================== -->
<div id="loginBox" class="card" style="display:none">
  <h3>Login</h3>

  <input type="password" id="pw" placeholder="Master password">
  <button onclick="login()">Enter</button>

  <hr>

  <!-- Restore backup -->
  <input type="file" onchange="restore(event)">
</div>

<!-- ===================== -->
<!-- MAIN APPLICATION -->
<!-- ===================== -->
<div id="app" style="display:none">

  <!-- NAVIGATION -->
  <div class="nav">
    <button onclick="show('products')">Inventory</button>
    <button onclick="show('sales')">Sales</button>
    <button onclick="show('clients')">Clients</button>
    <button onclick="backup()">Export Backup</button>
  </div>

  <!-- ===================== -->
  <!-- PRODUCTS VIEW -->
  <!-- ===================== -->
  <div id="products" class="card view">
    <h3>Add Product</h3>

    <input id="pstock" placeholder="Stock ID / QR">
    <button onclick="startScan('pstock')">Scan</button><br>

    <input id="pname" placeholder="Name">
    <input id="pprice" placeholder="Price">
    <input id="pvat" placeholder="VAT %">
    <input id="pqty" placeholder="Qty">

    <button onclick="addProduct()">Add</button>

    <table id="ptable"></table>
  </div>

  <!-- ===================== -->
  <!-- SALES VIEW -->
  <!-- ===================== -->
  <div id="sales" class="card view" style="display:none">
    <h3>New Sale</h3>

    <input id="saleQR" placeholder="Scan product QR">
    <button onclick="startScan('saleQR')">Scan</button><br>

    <select id="saleProduct"></select>
    <input id="saleQty" placeholder="Qty">
    <select id="saleClient"></select>

    <label>
      <input type="checkbox" id="saleDebt"> Debt
    </label>

    <button onclick="makeSale()">Sell</button>

    <table id="stable"></table>
  </div>

  <!-- ===================== -->
  <!-- CLIENTS VIEW -->
  <!-- ===================== -->
  <div id="clients" class="card view" style="display:none">
    <h3>Add Client</h3>

    <input id="cname" placeholder="Name">
    <input id="cphone" placeholder="Phone">

    <button onclick="addClient()">Add</button>

    <table id="ctable"></table>
  </div>

</div>

<!-- ===================== -->
<!-- SCANNER MODAL -->
<!-- ===================== -->
<div id="scanner"
     style="position:fixed; inset:0; background:#000c;
            display:none; align-items:center;
            justify-content:center; z-index:999">

  <div style="background:#fff; padding:10px; border-radius:8px">
    <video id="video" autoplay style="width:300px"></video><br>
    <button onclick="stopScan()">Cancel</button>
  </div>
</div>

<!-- ===================== -->
<!-- JAVASCRIPT LOGIC -->
<!-- ===================== -->
<script>

/* ===================== */
/* DATABASE SETUP */
/* ===================== */
let db, scanTarget = null, stream = null;

const req = indexedDB.open("toyshop", 2);

req.onupgradeneeded = e => {
  db = e.target.result;

  db.createObjectStore("meta", { keyPath: "key" });
  db.createObjectStore("products", { keyPath: "id", autoIncrement: true });
  db.createObjectStore("sales", { keyPath: "id", autoIncrement: true });
  db.createObjectStore("clients", { keyPath: "id", autoIncrement: true });
};

req.onsuccess = e => {
  db = e.target.result;
  checkInit();
};

function tx(store, mode = "readonly") {
  return db.transaction(store, mode).objectStore(store);
}

function hash(s) {
  return btoa(s);
}

/* ===================== */
/* INIT & AUTH */
/* ===================== */
function checkInit() {
  tx("meta").get("pw").onsuccess = e => {
    e.target.result
      ? loginBox.style.display = "block"
      : setupBox.style.display = "block";
  };
}

function createMaster() {
  if (!newpw.value) return alert("Password required");

  tx("meta", "readwrite").put({
    key: "pw",
    val: hash(newpw.value)
  });

  setupBox.style.display = "none";
  loginBox.style.display = "block";
}

function login() {
  tx("meta").get("pw").onsuccess = e => {
    if (hash(pw.value) === e.target.result.val) {
      loginBox.style.display = "none";
      app.style.display = "block";
      loadAll();
    } else {
      alert("Wrong password");
    }
  };
}

/* ===================== */
/* NAVIGATION */
/* ===================== */
function show(id) {
  document.querySelectorAll(".view")
    .forEach(v => v.style.display = "none");

  document.getElementById(id).style.display = "block";
}

/* ===================== */
/* PRODUCTS */
/* ===================== */
function stockExists(stock, cb) {
  tx("products").getAll().onsuccess = e => {
    cb(e.target.result.some(p => p.stockId === stock));
  };
}

function addProduct() {
  let stock = pstock.value.trim();
  if (!stock) return alert("Stock ID required");

  stockExists(stock, exists => {
    if (exists) return alert("Stock ID already exists");

    tx("products", "readwrite").add({
      stockId: stock,
      name: pname.value,
      price: +pprice.value,
      vat: +pvat.value,
      qty: +pqty.value
    });

    loadProducts();
  });
}

function loadProducts() {
  let t = "<tr><th>Stock</th><th>Name</th><th>Price</th><th>VAT</th><th>Qty</th></tr>";
  saleProduct.innerHTML = "";

  tx("products").getAll().onsuccess = e => {
    e.target.result.forEach(p => {
      t += `<tr>
              <td>${p.stockId}</td>
              <td>${p.name}</td>
              <td>${p.price}</td>
              <td>${p.vat}%</td>
              <td>${p.qty}</td>
            </tr>`;

      saleProduct.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    });

    ptable.innerHTML = t;
  };
}

/* ===================== */
/* CLIENTS */
/* ===================== */
function addClient() {
  tx("clients", "readwrite").add({
    name: cname.value,
    phone: cphone.value,
    debt: 0
  });

  loadClients();
}

function loadClients() {
  let t = "<tr><th>Name</th><th>Phone</th><th>Debt</th></tr>";
  saleClient.innerHTML = "<option value=''>Cash Sale</option>";

  tx("clients").getAll().onsuccess = e => {
    e.target.result.forEach(c => {
      t += `<tr>
              <td>${c.name}</td>
              <td>${c.phone}</td>
              <td>${c.debt.toFixed(2)}</td>
            </tr>`;

      saleClient.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });

    ctable.innerHTML = t;
  };
}

/* ===================== */
/* SALES */
/* ===================== */
function autoSelect(stock) {
  tx("products").getAll().onsuccess = e => {
    let p = e.target.result.find(x => x.stockId === stock);

    if (p) {
      saleProduct.value = p.id;
      saleQty.value = saleQty.value || 1;
    } else {
      alert("Product not found");
    }
  };
}

function makeSale() {
  let qty = +saleQty.value;
  let qr = saleQR.value.trim();

  if (qr) {
    tx("products").getAll().onsuccess = e => {
      let p = e.target.result.find(x => x.stockId === qr);
      if (!p) return alert("Product not found");
      processSale(p, qty);
    };
  } else {
    tx("products", "readwrite")
      .get(+saleProduct.value)
      .onsuccess = e => processSale(e.target.result, qty);
  }
}

function processSale(p, qty) {
  if (p.qty < qty) return alert("No stock");

  p.qty -= qty;
  tx("products", "readwrite").put(p);

  let vat = p.price * qty * (p.vat / 100);
  let total = p.price * qty + vat;

  tx("sales", "readwrite").add({
    date: new Date().toISOString(),
    product: p.name,
    stockId: p.stockId,
    qty,
    total,
    vat
  });

  if (saleDebt.checked && saleClient.value) {
    tx("clients", "readwrite")
      .get(+saleClient.value)
      .onsuccess = c => {
        let cl = c.target.result;
        cl.debt += total;
        tx("clients", "readwrite").put(cl);
      };
  }

  loadAll();
}

function loadSales() {
  let t = "<tr><th>Date</th><th>Product</th><th>Stock</th><th>Qty</th><th>Total</th></tr>";

  tx("sales").getAll().onsuccess = e => {
    e.target.result.forEach(s => {
      t += `<tr>
              <td>${s.date}</td>
              <td>${s.product}</td>
              <td>${s.stockId}</td>
              <td>${s.qty}</td>
              <td>${s.total.toFixed(2)}</td>
            </tr>`;
    });

    stable.innerHTML = t;
  };
}

/* ===================== */
/* LOAD ALL */
/* ===================== */
function loadAll() {
  loadProducts();
  loadClients();
  loadSales();
}

/* ===================== */
/* BACKUP & RESTORE */
/* ===================== */
function backup() {
  let dump = {};
  let stores = ["meta", "products", "sales", "clients"];
  let left = stores.length;

  stores.forEach(s =>
    tx(s).getAll().onsuccess = e => {
      dump[s] = e.target.result;
      if (--left === 0) {
        let a = document.createElement("a");
        a.href = URL.createObjectURL(
          new Blob([JSON.stringify(dump)], { type: "application/json" })
        );
        a.download = "toyshop-backup.json";
        a.click();
      }
    }
  );
}

function restore(ev) {
  let r = new FileReader();

  r.onload = () => {
    let d = JSON.parse(r.result);
    Object.keys(d).forEach(s =>
      d[s].forEach(x => tx(s, "readwrite").put(x))
    );
    alert("Reload page");
  };

  r.readAsText(ev.target.files[0]);
}

/* ===================== */
/* QR / BARCODE SCANNER */
/* ===================== */
function beep() {
  new Audio(
    "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA="
  ).play();
}

async function startScan(target) {
  if (!("BarcodeDetector" in window))
    return alert("Scanner not supported");

  scanTarget = target;

  const detector = new BarcodeDetector({
    formats: ["qr_code", "ean_13", "code_128", "upc_a"]
  });

  scanner.style.display = "flex";

  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });

  video.srcObject = stream;

  const loop = async () => {
    if (!stream) return;

    let codes = await detector.detect(video);
    if (codes.length) {
      let val = codes[0].rawValue;
      document.getElementById(scanTarget).value = val;
      beep();
      if (scanTarget === "saleQR") autoSelect(val);
      stopScan();
    } else {
      requestAnimationFrame(loop);
    }
  };

  loop();
}

function stopScan() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  scanner.style.display = "none";
}

</script>
</body>
</html>