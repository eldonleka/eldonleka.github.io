<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<!-- Prevent Safari zoom when focusing inputs; keep responsive -->
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
<title>Vault — Local Encrypted Passwords</title>

<!-- Tailwind Play CDN for quick styling (no build step) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Tiny animation helpers + mobile-friendly tweaks -->
<style>
  /* subtle card hover */
  .card {
    transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
  }
  .card:hover { transform: translateY(-6px); box-shadow: 0 10px 30px rgba(2,6,23,0.12); }
  /* fade & pop */
  .fadeIn { animation: fadeIn .28s ease both; }
  @keyframes fadeIn {
    from { opacity:0; transform: translateY(6px) scale(.995); }
    to { opacity:1; transform: translateY(0) scale(1); }
  }
  /* floating button ripple */
  .fab:active { transform: scale(.98); }

  /* mobile touch / accessibility */
  input, button, textarea, select {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    -webkit-touch-callout: none;
    font-size: 16px; /* prevents iOS zoom on focus */
  }
  button { min-height: 44px; min-width: 44px; padding: 10px 12px; }
  .small-btn { padding: 8px 10px; min-height: 44px; }

  /* small scrollable card list */
  .card-list { max-height: 46vh; overflow:auto; padding-right:6px; -webkit-overflow-scrolling: touch; }
  /* responsive tweaks */
  @media (max-width:640px){
    .card-list { max-height: 60vh; padding-right:6px; }
    header { padding-left:12px; padding-right:12px; }
    main { padding-left:12px; padding-right:12px; }
    .fab { right:16px; bottom:16px; }
    .card { margin-bottom: 8px; }
    /* stack right column under entries for small screens */
    .grid.md\\:grid-cols-3 { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    .md\\:col-span-2 { grid-column: auto; }
    aside { width: 100%; }
  }

  /* modal full-screen on mobile */
  #modal .bg-slate-900 { max-height: 92vh; overflow:auto; -webkit-overflow-scrolling: touch; }

  /* reduce left-right padding on tiny screens */
  @media (max-width:400px) {
    .px-6 { padding-left: 0.75rem; padding-right: 0.75rem; }
  }
</style>
</head>
<body class="bg-slate-900 text-slate-100 antialiased">

<div class="min-h-screen flex flex-col">
  <!-- Header -->
  <header class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
    <div class="flex items-center gap-3">
      <svg width="34" height="34" viewBox="0 0 24 24" class="text-emerald-400" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="16" rx="3" stroke="currentColor" stroke-width="1.5"></rect><path d="M8 11h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg>
      <div>
        <h1 class="text-lg font-semibold">Vault</h1>
        <p class="text-sm text-slate-400">Local encrypted vault — client-side only</p>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <button id="helpBtn" class="text-sm small-btn rounded-md bg-slate-800 hover:bg-slate-700 transition">Help</button>
      <button id="lockNowBtn" class="text-sm small-btn rounded-md bg-rose-600 hover:bg-rose-500 transition">Lock</button>
    </div>
  </header>

  <main class="flex-1 p-6">
    <!-- Top controls -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="card bg-slate-800 rounded-lg p-4 fadeIn">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-sm text-slate-300 font-medium">Vault file</h2>
            <p class="text-xs text-slate-400 mt-1">Open an encrypted vault (.json) or create a new one.</p>
            <div class="mt-3 flex gap-2">
              <input id="fileInput" type="file" accept=".json" class="hidden" />
              <button id="chooseFileBtn" class="px-3 py-2 text-sm rounded bg-slate-700 hover:bg-slate-600">Choose file</button>
              <button id="createBtn" class="px-3 py-2 text-sm rounded bg-emerald-500 text-black hover:bg-emerald-400">Create new</button>
            </div>
          </div>
          <div class="text-slate-400 text-xs text-right">
            <div id="vaultStatus" class="mb-1">No vault loaded</div>
            <div id="vaultInfo" class="text-xxs"></div>
          </div>
        </div>
      </div>

      <div class="card bg-slate-800 rounded-lg p-4 fadeIn">
        <h2 class="text-sm text-slate-300 font-medium">Actions</h2>
        <p class="text-xs text-slate-400 mt-1">Export or import the encrypted vault file.</p>
        <div class="mt-3 flex gap-2">
          <button id="exportBtn" class="px-3 py-2 rounded bg-sky-500 hover:bg-sky-400 text-black">Export Vault</button>
          <button id="importBtn" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600">Load Vault</button>
          <button id="syncGuideBtn" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600">GitHub Sync Steps</button>
        </div>
      </div>

      <div class="card bg-slate-800 rounded-lg p-4 fadeIn">
        <h2 class="text-sm text-slate-300 font-medium">Session</h2>
        <p class="text-xs text-slate-400 mt-1">Locking clears in-memory master key.</p>
        <div class="mt-3 flex gap-2">
          <button id="lockBtn" class="px-3 py-2 rounded bg-rose-600 hover:bg-rose-500">Lock Now</button>
          <button id="clearBtn" class="px-3 py-2 rounded bg-yellow-500 hover:bg-yellow-400 text-black">Clear Entries</button>
        </div>
      </div>
    </div>

    <div class="grid md:grid-cols-3 gap-6">
      <!-- Left: entries list -->
      <section class="md:col-span-2">
        <div class="card bg-slate-800 rounded-lg p-4 fadeIn">
          <div class="flex items-center justify-between">
            <h3 class="text-sm text-slate-300 font-medium">Entries</h3>
            <div class="flex items-center gap-2">
              <input id="searchInput" placeholder="Search service or username..." class="px-3 py-2 bg-slate-700 rounded text-sm text-slate-200 w-56 sm:w-64 md:w-72" />
            </div>
          </div>

          <div class="mt-4 card-list">
            <div id="entriesGrid" class="grid gap-3"></div>
          </div>

        </div>
      </section>

      <!-- Right: add/edit card -->
      <aside>
        <div class="card bg-slate-800 rounded-lg p-4 fadeIn">
          <h3 class="text-sm text-slate-300 font-medium">Add / Edit</h3>
          <div class="mt-3 space-y-3">
            <input id="site" placeholder="Website / Service" class="w-full px-3 py-2 bg-slate-700 rounded text-slate-100" />
            <input id="user" placeholder="Email / Username" class="w-full px-3 py-2 bg-slate-700 rounded text-slate-100" />
            <div class="relative">
              <input id="pwd" placeholder="Password" type="password" class="w-full px-3 py-2 bg-slate-700 rounded text-slate-100 pr-28" />
              <button id="showPwdBtn" class="absolute right-1 top-1/2 -translate-y-1/2 px-3 py-1 rounded bg-slate-600 text-xs">Show</button>
            </div>
            <input id="note" placeholder="Note (optional)" class="w-full px-3 py-2 bg-slate-700 rounded text-slate-100" />
            <div class="flex gap-2">
              <button id="saveBtn" class="flex-1 px-3 py-2 rounded bg-emerald-500 text-black">Save</button>
              <button id="newBtn" class="px-3 py-2 rounded bg-slate-700">New</button>
            </div>
          </div>
        </div>

        <div class="mt-4 card bg-slate-800 rounded-lg p-4 fadeIn">
          <h3 class="text-sm text-slate-300 font-medium">Quick actions</h3>
          <div class="mt-3 grid gap-2">
            <button id="copyAllBtn" class="px-3 py-2 rounded bg-sky-500 text-black">Copy Username & Password</button>
            <button id="revealAllBtn" class="px-3 py-2 rounded bg-rose-500">Reveal All (Auth)</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Floating add button -->
  <button id="fabAdd" class="fab fixed right-6 bottom-6 bg-emerald-500 text-black p-4 rounded-full shadow-lg hover:shadow-2xl transition">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>

  <!-- Footer -->
  <footer class="px-6 py-4 text-xs text-slate-400 border-t border-slate-800">
    Client-side encryption • Keep master password safe • Export / commit vault.json to your private GitHub repo to sync
  </footer>
</div>

<!-- Modal layer -->
<div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
  <div class="bg-slate-900 rounded-lg p-5 w-full max-w-xl text-slate-100">
    <div id="modalContent"></div>
    <div class="mt-4 text-right"><button id="modalClose" class="px-3 py-2 rounded bg-slate-700">Close</button></div>
  </div>
</div>

<script>
/* Modern encrypted vault JS.
   Same encryption: PBKDF2 -> AES-GCM
   Vault JSON: { version:1, salt, iv, ct }
*/
(async()=>{

// UI refs
const chooseFileBtn = document.getElementById('chooseFileBtn');
const createBtn = document.getElementById('createBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const syncGuideBtn = document.getElementById('syncGuideBtn');
const lockNowBtn = document.getElementById('lockNowBtn');
const lockBtn = document.getElementById('lockBtn');
const clearBtn = document.getElementById('clearBtn');
const helpBtn = document.getElementById('helpBtn');
const fileInput = document.getElementById('fileInput');
const vaultStatus = document.getElementById('vaultStatus');
const vaultInfo = document.getElementById('vaultInfo');

const entriesGrid = document.getElementById('entriesGrid');
const searchInput = document.getElementById('searchInput');

const siteEl = document.getElementById('site');
const userEl = document.getElementById('user');
const pwdEl = document.getElementById('pwd');
const noteEl = document.getElementById('note');
const saveBtn = document.getElementById('saveBtn');
const newBtn = document.getElementById('newBtn');
const showPwdBtn = document.getElementById('showPwdBtn');

const copyAllBtn = document.getElementById('copyAllBtn');
const revealAllBtn = document.getElementById('revealAllBtn');
const fabAdd = document.getElementById('fabAdd');

const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const modalClose = document.getElementById('modalClose');

let vaultObj = null; // loaded vault JSON
let entries = [];   // decrypted entries (plaintext) {service, username, password, note}
let master = null;  // master password in memory while unlocked
let currentEdit = null; // index or null

// helpers
function showModal(html){
  modalContent.innerHTML = html;
  modal.classList.remove('hidden'); modal.classList.add('flex');
}
function hideModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }

modalClose.onclick = hideModal;

// base64 helpers
function abToBase64(buffer){
  let binary=''; const bytes=new Uint8Array(buffer); for(let i=0;i<bytes.byteLength;i++) binary+=String.fromCharCode(bytes[i]);
  return btoa(binary);
}
function base64ToAb(base64){
  const binary = atob(base64); const len = binary.length; const bytes = new Uint8Array(len);
  for(let i=0;i<len;i++) bytes[i]=binary.charCodeAt(i); return bytes.buffer;
}
function strToAb(s){ return new TextEncoder().encode(s); }
function abToStr(ab){ return new TextDecoder().decode(ab); }

// crypto: derive and encrypt/decrypt
async function deriveKey(password, saltB64, iterations=200000){
  const salt = base64ToAb(saltB64);
  const pwKey = await crypto.subtle.importKey('raw', strToAb(password), 'PBKDF2', false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations, hash:'SHA-256'},
    pwKey,
    {name:'AES-GCM', length:256},
    false,
    ['encrypt','decrypt']
  );
  return key;
}
async function encryptText(key, text){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, strToAb(text));
  return {iv: abToBase64(iv), ct: abToBase64(ct)};
}
async function decryptText(key, ivB64, ctB64){
  const iv = new Uint8Array(base64ToAb(ivB64));
  const ct = base64ToAb(ctB64);
  const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
  return abToStr(plain);
}

// create vault
async function createEmptyVault(password){
  const saltArr = crypto.getRandomValues(new Uint8Array(16));
  const saltB64 = abToBase64(saltArr);
  const key = await deriveKey(password, saltB64);
  const cipher = await encryptText(key, JSON.stringify([]));
  const fileObj = {version:1, salt: saltB64, iv: cipher.iv, ct: cipher.ct};
  vaultObj = fileObj; entries = []; master = password;
  updateStatus('New vault (unsaved)');
  renderEntries();
  return fileObj;
}

// open selected file
function readFileAsText(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsText(file); }); }
async function openVaultFile(file, password){
  try{
    const txt = await readFileAsText(file);
    const obj = JSON.parse(txt);
    if(!obj.salt || !obj.ct || !obj.iv) throw new Error('Invalid vault format');
    const key = await deriveKey(password, obj.salt);
    const plain = await decryptText(key, obj.iv, obj.ct);
    entries = JSON.parse(plain);
    vaultObj = obj; master = password;
    updateStatus('Vault loaded');
    renderEntries();
    return true;
  }catch(err){
    console.error(err);
    alert('Failed to open vault. Wrong password or corrupted file.');
    return false;
  }
}

// export current vault
async function exportVault(){
  if(!vaultObj || master===null) return alert('No vault loaded.');
  const key = await deriveKey(master, vaultObj.salt);
  const cipher = await encryptText(key, JSON.stringify(entries));
  const fileObj = {version:1, salt: vaultObj.salt, iv: cipher.iv, ct: cipher.ct};
  const blob = new Blob([JSON.stringify(fileObj, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'vault.json'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },400);
  updateStatus('Vault exported');
}

// UI status
function updateStatus(text){
  vaultStatus.textContent = text;
  vaultInfo.textContent = master ? 'Unlocked' : 'Locked';
}

// entries rendering
function renderEntries(filter=''){
  entriesGrid.innerHTML = '';
  const q = filter.trim().toLowerCase();
  const filtered = entries.filter(e=>{
    if(!q) return true;
    return (e.service||'').toLowerCase().includes(q) || (e.username||'').toLowerCase().includes(q);
  });
  if(filtered.length===0){
    entriesGrid.innerHTML = `<div class="text-slate-400 p-4">No entries</div>`;
    return;
  }
  filtered.forEach((it, idx)=>{
    const card = document.createElement('div');
    card.className = 'p-3 bg-slate-800 rounded-lg flex items-start justify-between gap-3 card';
    card.innerHTML = `
      <div>
        <div class="text-sky-300 font-semibold">${escapeHtml(it.service)}</div>
        <div class="text-slate-300 text-sm">${escapeHtml(it.username)}</div>
        <div class="text-slate-400 text-xs mt-1">${escapeHtml(it.note||'')}</div>
      </div>
      <div class="flex flex-col items-end gap-2">
        <div class="flex gap-2">
          <button data-idx="${idx}" class="px-2 py-1 rounded bg-slate-700 text-xs">Reveal</button>
          <button data-edit="${idx}" class="px-2 py-1 rounded bg-emerald-600 text-xs text-black">Edit</button>
          <button data-del="${idx}" class="px-2 py-1 rounded bg-rose-600 text-xs">Del</button>
        </div>
      </div>
    `;
    entriesGrid.appendChild(card);
  });
  // bind
  entriesGrid.querySelectorAll('button[data-idx]').forEach(b=>{
    b.onclick = ()=>{ const i=+b.dataset.idx; revealCopy(i); };
  });
  entriesGrid.querySelectorAll('button[data-edit]').forEach(b=>{
    b.onclick = ()=>{ const i=+b.dataset.edit; loadEdit(i); };
  });
  entriesGrid.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick = ()=>{ const i=+b.dataset.del; if(confirm('Delete entry?')){ entries.splice(i,1); renderEntries(); } };
  });
}

function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// reveal and copy
function revealCopy(i){
  const it = entries[i];
  if(!it) return;
  navigator.clipboard?.writeText(it.password).then(()=> alert('Password copied')).catch(()=> {
    // fallback
    const ta = document.createElement('textarea'); ta.value = it.password; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove(); alert('Password copied (fallback).');
  });
}

// load into edit fields
function loadEdit(i){
  currentEdit = i;
  const it = entries[i];
  siteEl.value = it.service; userEl.value = it.username; pwdEl.value = it.password; noteEl.value = it.note||'';
  siteEl.focus();
}

// event handlers
chooseFileBtn.onclick = ()=> fileInput.click();
fileInput.onchange = ()=> {
  if(!fileInput.files.length) return;
  const file = fileInput.files[0];
  // ask for master password (prompt is fine on mobile)
  const pw = prompt('Enter master password to open vault:');
  if(!pw) return;
  openVaultFile(file, pw);
};

createBtn.onclick = async ()=>{
  const pw = prompt('Create a strong master password (long passphrase):');
  if(!pw) return;
  await createEmptyVault(pw);
  alert('New vault created in memory. Export to save a vault.json file for backup or sync.');
};

importBtn.onclick = ()=> fileInput.click();
exportBtn.onclick = exportVault;

saveBtn.onclick = ()=>{
  const s = siteEl.value.trim(), u = userEl.value.trim(), p = pwdEl.value, n = noteEl.value.trim();
  if(!s || !u || !p) return alert('Service, username and password required.');
  const idx = entries.findIndex(e=>e.service === s);
  const obj = {service:s, username:u, password:p, note:n};
  if(currentEdit !== null && entries[currentEdit] && entries[currentEdit].service===s){
    entries[currentEdit] = obj;
    currentEdit = null;
  } else if(idx>=0) {
    // replace existing by service name
    entries[idx] = obj;
  } else {
    entries.push(obj);
  }
  siteEl.value=''; userEl.value=''; pwdEl.value=''; noteEl.value='';
  renderEntries(searchInput.value);
};

newBtn.onclick = ()=>{
  currentEdit = null;
  siteEl.value=''; userEl.value=''; pwdEl.value=''; noteEl.value='';
};

showPwdBtn.onclick = ()=> {
  if(pwdEl.type==='password'){ pwdEl.type='text'; showPwdBtn.textContent='Hide'; }
  else { pwdEl.type='password'; showPwdBtn.textContent='Show'; }
};

fabAdd.onclick = ()=> { window.scrollTo({top:0, behavior:'smooth'}); siteEl.focus(); };

// search
searchInput.oninput = ()=> renderEntries(searchInput.value);

// lock / clear
lockBtn.onclick = lockNowBtn.onclick = ()=>{
  if(!vaultObj) return;
  master = null; vaultObj = null; entries = []; updateStatus('Locked'); renderEntries();
  alert('Locked. You must reload a vault file to continue.');
};

clearBtn.onclick = ()=> {
  if(!confirm('Clear all entries in-memory? This does NOT delete saved vault file.')) return;
  entries=[]; renderEntries();
};

// copy all username+password for currently visible entries (dangerous)
copyAllBtn.onclick = ()=>{
  if(entries.length===0) return alert('No entries');
  // combine first visible (or all) into a string for clipboard
  const visible = entries; let out='';
  visible.forEach(it=> out += `${it.service}\n${it.username}\n${it.password}\n\n`);
  navigator.clipboard?.writeText(out).then(()=> alert('All credentials copied (be careful!)')).catch(()=> alert('Copy failed.'));
};

// reveal all requires re-confirmation
revealAllBtn.onclick = async ()=>{
  if(!vaultObj) return alert('No vault loaded.');
  const pw = prompt('Re-enter master password to reveal all:');
  if(!pw) return;
  // try derive
  try{
    const key = await deriveKey(pw, vaultObj.salt);
    // quick decrypt test
    const plain = await decryptText(key, vaultObj.iv, vaultObj.ct);
    // decrypt each entry and show modal
    let html = '<h3 class="text-lg font-semibold mb-2">All credentials</h3><div class="space-y-2">';
    entries.forEach(it=>{
      html += `<div class="p-3 bg-slate-800 rounded"><div class="font-semibold text-sky-300">${escapeHtml(it.service)}</div><div class="text-slate-300">${escapeHtml(it.username)}</div><div class="text-emerald-300">${escapeHtml(it.password)}</div><div class="text-slate-400 text-xs mt-1">${escapeHtml(it.note||'')}</div></div>`;
    });
    html += '</div>';
    showModal(html);
  }catch(e){
    alert('Wrong master password.');
  }
};

// help & sync guide
helpBtn.onclick = ()=> {
  showModal(`<h3 class="text-lg font-semibold mb-2">Quick help</h3>
    <p class="text-slate-300">This app encrypts and decrypts your vault in your browser only. Use <strong>Export Vault</strong> to download <code>vault.json</code> and upload it to your private GitHub repo. On other devices, download the file and open it here.</p>
  `);
};

syncGuideBtn.onclick = ()=> {
  showModal(`<h3 class="text-lg font-semibold mb-2">GitHub Sync Steps</h3>
    <ol class="list-decimal pl-5">
      <li>Create a <strong>private</strong> repo on GitHub.</li>
      <li>Upload the exported <code>vault.json</code> via Add file → Upload files.</li>
      <li>On other devices, download the file into that device and open it with this app (Choose file).</li>
      <li>When you update, Export vault and replace the file in the repo (upload/commit).</li>
    </ol>
    <p class="text-slate-400 text-sm mt-2">Keep the repo private and never share master password.</p>
  `);
};

// initial status
updateStatus('No vault loaded');
renderEntries();

})(); // IIFE end
</script>

</body>
</html>