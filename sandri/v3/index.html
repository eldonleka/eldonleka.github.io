<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Toy Shop Manager</title>

<style>
body { font-family: Arial; margin:20px; background:#f4f4f4 }
.card { background:white; padding:15px; margin:10px 0; border-radius:8px }
button { padding:8px 12px; margin:4px; cursor:pointer }
input, select { padding:6px; margin:4px }
table { border-collapse: collapse; width:100% }
td,th { border:1px solid #ccc; padding:6px }
.nav button { background:#333; color:white }
</style>
</head>

<body>

<h2>Toy Shop Manager</h2>

<!-- FIRST RUN -->
<div id="setupBox" class="card" style="display:none">
<h3>First Time Setup</h3>
<input type="password" id="newpw" placeholder="Create master password">
<button onclick="createMaster()">Create Password</button>
<hr>
<b>Or restore from backup:</b><br>
<input type="file" onchange="restore(event)">
</div>

<!-- LOGIN -->
<div id="loginBox" class="card" style="display:none">
<h3>Login</h3>
<input type="password" id="pw" placeholder="Master password">
<button onclick="login()">Enter</button>
<hr>
Restore backup DB:
<input type="file" onchange="restore(event)">
</div>

<!-- APP -->
<div id="app" style="display:none">

<div class="nav">
<button onclick="show('products')">Inventory</button>
<button onclick="show('sales')">Sales</button>
<button onclick="show('clients')">Clients</button>
<button onclick="backup()">Export Backup</button>
</div>

<!-- PRODUCTS -->
<div id="products" class="card view">
<h3>Add Product</h3>
<input id="pstock" placeholder="Stock ID / QR code">
<input id="pname" placeholder="Name">
<input id="pprice" placeholder="Price">
<input id="pvat" placeholder="VAT %">
<input id="pqty" placeholder="Qty">
<button onclick="addProduct()">Add</button>
<table id="ptable"></table>
</div>

<!-- SALES -->
<div id="sales" class="card view" style="display:none">
<h3>New Sale</h3>
<input id="saleQR" placeholder="Scan QR code (optional)">
<br>
<select id="saleProduct"></select>
<input id="saleQty" placeholder="Qty">
<select id="saleClient"></select>
<label><input type="checkbox" id="saleDebt"> Debt</label>
<button onclick="makeSale()">Sell</button>
<table id="stable"></table>
</div>

<!-- CLIENTS -->
<div id="clients" class="card view" style="display:none">
<h3>Add Client</h3>
<input id="cname" placeholder="Name">
<input id="cphone" placeholder="Phone">
<button onclick="addClient()">Add</button>
<table id="ctable"></table>
</div>

</div>

<script>
let db;
const req = indexedDB.open("toyshop",2);

req.onupgradeneeded = e=>{
 db = e.target.result;
 db.createObjectStore("meta",{keyPath:"key"});
 db.createObjectStore("products",{keyPath:"id",autoIncrement:true});
 db.createObjectStore("sales",{keyPath:"id",autoIncrement:true});
 db.createObjectStore("clients",{keyPath:"id",autoIncrement:true});
};

req.onsuccess = e=>{
 db = e.target.result;
 checkInit();
};

function tx(s,m="readonly"){ return db.transaction(s,m).objectStore(s); }
function hash(s){ return btoa(s); }

/* ---------- INIT ---------- */

function checkInit(){
 tx("meta").get("pw").onsuccess=e=>{
  if(!e.target.result) setupBox.style.display="block";
  else loginBox.style.display="block";
 };
}

function createMaster(){
 let pwv = newpw.value.trim();
 if(!pwv) return alert("Enter password");
 tx("meta","readwrite").put({key:"pw",val:hash(pwv)});
 setupBox.style.display="none";
 loginBox.style.display="block";
}

/* ---------- LOGIN ---------- */

function login(){
 tx("meta").get("pw").onsuccess=e=>{
  if(hash(pw.value)===e.target.result.val) openApp();
  else alert("Wrong password");
 };
}

function openApp(){
 loginBox.style.display="none";
 app.style.display="block";
 loadAll();
}

/* ---------- NAV ---------- */

function show(id){
 document.querySelectorAll(".view").forEach(v=>v.style.display="none");
 document.getElementById(id).style.display="block";
}

/* ---------- PRODUCTS ---------- */

function addProduct(){
 tx("products","readwrite").add({
  stockId: pstock.value.trim(),
  name: pname.value,
  price:+pprice.value,
  vat:+pvat.value,
  qty:+pqty.value
 });
 loadProducts();
}

function loadProducts(){
 let t="<tr><th>Stock ID</th><th>Name</th><th>Price</th><th>VAT</th><th>Qty</th></tr>";
 saleProduct.innerHTML="";
 tx("products").getAll().onsuccess=e=>{
  e.target.result.forEach(p=>{
   t+=`<tr>
   <td>${p.stockId||""}</td>
   <td>${p.name}</td>
   <td>${p.price}</td>
   <td>${p.vat}%</td>
   <td>${p.qty}</td>
   </tr>`;
   saleProduct.innerHTML+=`<option value="${p.id}">${p.name}</option>`;
  });
  ptable.innerHTML=t;
 };
}

/* ---------- CLIENTS ---------- */

function addClient(){
 tx("clients","readwrite").add({name:cname.value,phone:cphone.value,debt:0});
 loadClients();
}

function loadClients(){
 let t="<tr><th>Name</th><th>Phone</th><th>Debt</th></tr>";
 saleClient.innerHTML="<option value=''>Cash Sale</option>";
 tx("clients").getAll().onsuccess=e=>{
  e.target.result.forEach(c=>{
   t+=`<tr><td>${c.name}</td><td>${c.phone}</td><td>${c.debt.toFixed(2)}</td></tr>`;
   saleClient.innerHTML+=`<option value="${c.id}">${c.name}</option>`;
  });
  ctable.innerHTML=t;
 };
}

/* ---------- SALES ---------- */

function findByStock(stock, cb){
 tx("products").getAll().onsuccess=e=>{
  cb(e.target.result.find(p=>p.stockId===stock));
 };
}

function makeSale(){
 let qty = +saleQty.value;
 let qr = saleQR.value.trim();

 if(qr){
  findByStock(qr,p=>{
   if(!p) return alert("Product not found");
   processSale(p,qty);
  });
 } else {
  tx("products","readwrite").get(+saleProduct.value).onsuccess=e=>{
   processSale(e.target.result,qty);
  };
 }
}

function processSale(p,qty){
 if(p.qty<qty) return alert("No stock");

 p.qty-=qty;
 tx("products","readwrite").put(p);

 let vat=p.price*qty*(p.vat/100);
 let total=p.price*qty+vat;

 tx("sales","readwrite").add({
  date:new Date().toISOString(),
  product:p.name,
  stockId:p.stockId,
  qty,total,vat
 });

 if(saleDebt.checked && saleClient.value){
  tx("clients","readwrite").get(+saleClient.value).onsuccess=c=>{
   let cl=c.target.result;
   cl.debt+=total;
   tx("clients","readwrite").put(cl);
  };
 }

 loadAll();
}

function loadSales(){
 let t="<tr><th>Date</th><th>Product</th><th>Stock ID</th><th>Qty</th><th>Total</th><th>VAT</th></tr>";
 tx("sales").getAll().onsuccess=e=>{
  e.target.result.forEach(s=>{
   t+=`<tr>
   <td>${s.date}</td>
   <td>${s.product}</td>
   <td>${s.stockId||""}</td>
   <td>${s.qty}</td>
   <td>${s.total.toFixed(2)}</td>
   <td>${s.vat.toFixed(2)}</td>
   </tr>`;
  });
  stable.innerHTML=t;
 };
}

/* ---------- LOAD ---------- */

function loadAll(){
 loadProducts();
 loadClients();
 loadSales();
}

/* ---------- BACKUP ---------- */

function backup(){
 let dump={}, stores=["meta","products","sales","clients"], left=stores.length;
 stores.forEach(s=>{
  tx(s).getAll().onsuccess=e=>{
   dump[s]=e.target.result;
   if(--left===0){
    let blob=new Blob([JSON.stringify(dump)],{type:"application/json"});
    let a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="toyshop-backup.json";
    a.click();
   }
  };
 });
}

/* ---------- RESTORE ---------- */

function restore(ev){
 let f=ev.target.files[0];
 if(!f) return;
 let r=new FileReader();
 r.onload=()=>{
  let data=JSON.parse(r.result);
  Object.keys(data).forEach(s=>{
   let store=tx(s,"readwrite");
   data[s].forEach(row=>store.put(row));
  });
  alert("Backup restored â€” reload page");
 };
 r.readAsText(f);
}
</script>

</body>
</html>